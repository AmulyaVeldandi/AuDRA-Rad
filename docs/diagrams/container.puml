@startuml AuDRA-Rad Container Diagram
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

LAYOUT_TOP_DOWN()

title Container Diagram - AuDRA-Rad System

Person(clinician, "Clinician", "Radiologist/Physician")
System_Ext(ehr, "EHR System", "FHIR R4")
System_Ext(ris, "RIS", "Radiology reports")
System_Ext(llm, "LLM Service", "NVIDIA NIM / Ollama")
System_Ext(embedding, "Embedding Service", "NIM / nomic-embed-text")

System_Boundary(audra, "AuDRA-Rad System") {
    Container(web_ui, "Web Application", "React, TypeScript", "Interactive dashboard for report upload, review findings, approve tasks")
    Container(api, "REST API", "FastAPI, Python 3.10+", "Exposes endpoints for report processing, batch operations, health checks, metrics")
    Container(agent, "ReAct Agent Orchestrator", "Python, Pydantic", "Executes multi-step workflow: parse → retrieve → match → validate → generate")

    ContainerDb(state_store, "Session State Store", "In-Memory/Redis", "Tracks agent sessions, decision traces, audit logs")

    Container(parser, "Report Parser", "Python, Regex NLP", "Extracts structured findings from narrative text (size, location, characteristics)")
    Container(retriever, "Guideline Retrieval", "Python, Vector Search", "Semantic + hybrid search over medical guidelines (kNN + BM25)")
    Container(matcher, "Recommendation Matcher", "Python, LLM", "Maps findings to evidence-based recommendations via LLM reasoning")
    Container(validator, "Safety Validator", "Python, Rule Engine", "Flags high-risk cases (size >30mm, spiculated, missing citations)")
    Container(task_gen, "Task Generator", "Python, FHIR Builder", "Creates FHIR ServiceRequest resources with timing and reason")

    ContainerDb(vector_db, "Vector Store", "OpenSearch/Faiss", "Stores guideline embeddings (768-dim), HNSW index, supports kNN + BM25")
    Container(observability, "Observability Stack", "Structured Logging", "Decision traces, performance metrics, audit logs (JSON)")
}

Rel(clinician, web_ui, "Uses", "HTTPS")
Rel(web_ui, api, "Calls", "REST/JSON")
Rel(api, agent, "Invokes", "Async")

Rel(agent, parser, "Uses", "Sync")
Rel(agent, retriever, "Uses", "Sync")
Rel(agent, matcher, "Uses", "Sync")
Rel(agent, validator, "Uses", "Sync")
Rel(agent, task_gen, "Uses", "Sync")

Rel(agent, state_store, "Reads/Writes", "Session state, decision trace")
Rel(retriever, vector_db, "Searches", "kNN + BM25 hybrid search")
Rel(retriever, embedding, "Embeds queries", "HTTP REST")
Rel(matcher, llm, "Prompts", "HTTP REST")
Rel(parser, llm, "Extracts (optional)", "HTTP REST")

Rel(task_gen, ehr, "Creates orders", "FHIR REST POST /ServiceRequest")
Rel(ris, api, "Sends reports", "HL7 FHIR DiagnosticReport")

Rel(agent, observability, "Logs decisions", "Structured JSON with timestamps")

SHOW_LEGEND()
@enduml
