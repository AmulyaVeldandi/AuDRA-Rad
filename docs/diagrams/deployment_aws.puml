@startuml AWS Deployment Architecture
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Deployment.puml

LAYOUT_WITH_LEGEND()

title Deployment Diagram - AuDRA-Rad on AWS

Deployment_Node(aws, "AWS Cloud", "Region: us-west-2") {
    Deployment_Node(vpc, "Virtual Private Cloud", "10.0.0.0/16") {

        Deployment_Node(eks, "Amazon EKS Cluster", "Kubernetes 1.28") {
            Deployment_Node(web_pods, "Web App Pods", "Fargate/EC2 (2vCPU, 4GB)") {
                Container(web, "React App", "Nginx + Static Assets")
            }

            Deployment_Node(api_pods, "API Pods", "Auto-scaling: 2-10 replicas") {
                Container(api_container, "FastAPI", "Python 3.10, Uvicorn ASGI")
            }

            Deployment_Node(nim_llm_pods, "NIM LLM Pods", "GPU: g5.4xlarge (16GB VRAM)") {
                Container(nim_llm, "Nemotron NIM", "TensorRT-LLM, vLLM inference")
            }

            Deployment_Node(nim_embed_pods, "NIM Embedding Pods", "GPU: g5.xlarge") {
                Container(nim_embed, "NVEmbed NIM", "TensorRT, batch inference")
            }
        }

        Deployment_Node(opensearch, "OpenSearch Serverless", "Managed Service") {
            ContainerDb(vector_index, "medical_guidelines", "768-dim HNSW index, 3 shards")
        }

        Deployment_Node(elasticache, "ElastiCache Redis", "Optional, r6g.large") {
            ContainerDb(session_cache, "Session State", "Agent sessions, decision traces")
        }
    }

    Deployment_Node(alb, "Application Load Balancer", "ALB with TLS 1.3") {
        Container(ingress, "Ingress Controller", "AWS Load Balancer Controller")
    }

    Deployment_Node(s3, "S3 Buckets", "Versioned, encrypted") {
        ContainerDb(guideline_storage, "Guideline Corpus", "Markdown files (Fleischner, ACR)")
        ContainerDb(audit_logs, "Audit Logs", "Decision traces, immutable (MFA delete)")
    }

    Deployment_Node(cloudwatch, "CloudWatch", "Observability") {
        Container(metrics, "Metrics & Logs", "API latency, error rates, agent traces")
    }
}

Deployment_Node(external, "External Systems") {
    System_Ext(ehr_ext, "Hospital EHR", "FHIR R4 endpoint (mTLS)")
}

Rel(ingress, web, "Routes HTTPS traffic", "Path: /")
Rel(ingress, api_container, "Routes API requests", "Path: /api")
Rel(api_container, nim_llm, "LLM inference", "gRPC/HTTP")
Rel(api_container, nim_embed, "Embedding generation", "HTTP REST")
Rel(api_container, vector_index, "Vector search", "HTTPS")
Rel(api_container, session_cache, "State persistence", "Redis protocol")
Rel(api_container, ehr_ext, "FHIR requests", "HTTPS mTLS")
Rel(api_container, guideline_storage, "Read guidelines", "S3 API")
Rel(api_container, audit_logs, "Write audit logs", "S3 API")
Rel(api_container, metrics, "Send metrics/logs", "CloudWatch API")

SHOW_LEGEND()
@enduml
